from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
import re
import os

user_sums = {}

async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    welcome_text = """
ğŸ”¢ **Ø¨ÙˆØª Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ**

ğŸ¯ **ÙƒÙŠÙÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:**
â€¢ Ø£Ø±Ø³Ù„ Ø£ÙŠ Ø£Ø±Ù‚Ø§Ù… ÙˆØ³Ø£Ø¬Ù…Ø¹Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
â€¢ Ø§Ø³ØªØ®Ø¯Ù… /sum Ù…ØªØ¨ÙˆØ¹Ø§Ù‹ Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
â€¢ Ø§Ø³ØªØ®Ø¯Ù… /total Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ
â€¢ Ø§Ø³ØªØ®Ø¯Ù… /reset Ù„Ù…Ø³Ø­ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹

ğŸ“ **Ø£Ù…Ø«Ù„Ø©:**
10 20 30
Ø£Ùˆ: /sum 5 15 25
Ø£Ùˆ: "Ø§Ø´ØªØ±ÙŠØª 3 ØªÙØ§Ø­Ø§Øª Ø¨Ø³Ø¹Ø± 12.5"
    """
    await update.message.reply_text(welcome_text)

async def sum_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if context.args:
        numbers = []
        for arg in context.args:
            try:
                numbers.append(float(arg))
            except ValueError:
                pass
        if numbers:
            total = sum(numbers)
            user_sums[user_id] = user_sums.get(user_id, 0) + total
            await update.message.reply_text(f"âœ… ØªÙ… Ø¬Ù…Ø¹: {numbers}\nğŸ“Š Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: {total}\nğŸ’¾ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ: {user_sums[user_id]:.2f}")

async def total_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    current_total = user_sums.get(user_id, 0)
    await update.message.reply_text(f"ğŸ’° Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ: {current_total:.2f}")

async def reset_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    user_sums[user_id] = 0
    await update.message.reply_text("ğŸ”„ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­")

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    text = update.message.text
    
    numbers = [float(num) for num in re.findall(r'-?\d+\.?\d*', text)]
    
    if numbers:
        total = sum(numbers)
        user_sums[user_id] = user_sums.get(user_id, 0) + total
        await update.message.reply_text(f"ğŸ”¢ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…: {numbers}\nğŸ’° Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: {total}\nğŸ’¾ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ: {user_sums[user_id]:.2f}")

def main():
    TOKEN = os.environ.get('8599131309:AAEsBg0ez3wjaXvCUppjFRHkRKLwKljtL8Y')
    if not TOKEN:
        print("âŒ Error: BOT_TOKEN not found!")
        return
    
    app = Application.builder().token(TOKEN).build()
    
    app.add_handler(CommandHandler("start", start_command))
    app.add_handler(CommandHandler("sum", sum_command))
    app.add_handler(CommandHandler("total", total_command))
    app.add_handler(CommandHandler("reset", reset_command))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    print("âœ… Ø¨ÙˆØª Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙŠØ¹Ù…Ù„...")
    app.run_polling()

if __name__ == "__main__":
    main()
